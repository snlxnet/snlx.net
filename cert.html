<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Генератор сертификатов</title>
  <link rel="stylesheet" href="/main.css">
  <link rel="stylesheet" href="/spa.css">
  <style>
    :root {
      --template: url(/cert-placeholder.svg);
    }
    textarea {
      resize: none;
    }

    .uni-logo {
      width: 3rem;
      border-radius: var(--radius);
    }
    .uni-logo-bg {
      fill: var(--accent);
    }
    .uni-logo-fg {
      fill: var(--mantle);
    }
    .uni-logo-link {
      display: grid;
    }

    #preview {
      margin: 0 var(--padding);
      padding: 0 var(--padding);
      width: 100%;
      max-width: unset;
    }
    .typst-doc {
      max-width: 100%;
      width: 100%;
      height: unset;
      margin-bottom: var(--padding);
    }

    #names {
      position: sticky;
      top: var(--padding);

      max-width: 30ch;
      width: 100%;
      height: calc(100vh - var(--padding)*2);
      
      display: grid;
      grid-template-rows: 1fr auto;
    }
    #names label {
      display: grid;
      grid-template-rows: auto 1fr;
    }

    #settings {
      position: sticky;
      top: var(--padding);

      height: fit-content;
    }

    .suffix-percent,
    .suffix-pt {
      position: relative;
    }
    .suffix-percent::after,
    .suffix-pt::after {
      content: "%";
      position: absolute;
      top: 0;
      right: 0;
      padding: var(--padding);
    }
    .suffix-pt::after {
      content: "pt";
    }

    .broken {
      cursor: not-allowed;
    }

    @media print {
      * {
        margin: 0 !important;
        padding: 0 !important;
      }

      #names,
      #settings,
      .sidebar {
        display: none !important;
      }

      #preview,
      #preview * {
        display: auto !important;
      }
    }

    @keyframes breathe {
      0% { opacity: 1; }
      50% { opacity: 0.62; }
      100% { opacity: 1; }
    }
    .lucide-hourglass {
      animation: ease-in-out infinite 2s breathe;
      transform-origin: center;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <nav>
      <a href="https://kubstu.ru" class="uni-logo-link">
        <svg viewBox="0 0 16 16" class="uni-logo">
          <rect
            width="100%"
            height="100%"
            class="uni-logo-bg"
          />
          <path
            class="uni-logo-fg"
            d="
              M 16,2
              L 3,2
              L 3,4.5
              L 5,4.5
              L 5,14
              L 8,14
              L 8,4.5
              L 11,4.5
              L 11,11
              Q 11,14
                14,14
              Q 16,13.75
                16,13.5
              L 16,11.5
              Q 14,12
                14,10.5
              L 14,4.5
              L 16,4.5
              Z
            "
          />
        </svg>
      </a>
      <h2>
        <span lang="en">cert</span>
        <span lang="ru">Генератор сертификатов</span>
      </h2>
    </nav>
    <div>
      <span lang="en" title="not yet implemented :(">download</span>
      <span lang="ru" title="ещё не реализовано :(">скачать</span>
      <button id="save-each" style="background: var(--text)" class="broken">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download-icon lucide-download">
          <path d="M12 15V3"/>
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <path d="m7 10 5 5 5-5"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="container">
    <main id="preview">
      <svg xmlns="http://www.w3.org/2000/svg" width="30%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-hourglass-icon lucide-hourglass">
        <path d="M5 22h14"/>
        <path d="M5 2h14"/>
        <path d="M17 22v-4.172a2 2 0 0 0-.586-1.414L12 12l-4.414 4.414A2 2 0 0 0 7 17.828V22"/>
        <path d="M7 2v4.172a2 2 0 0 0 .586 1.414L12 12l4.414-4.414A2 2 0 0 0 17 6.172V2"/>
      </svg>
    </main>

    <form action="" id="settings">
      <fieldset>
        <legend>
          <span lang="en">Font</span>
          <span lang="ru">Шрифт</span>
        </legend>
        <label>
          <input type="text" name="font" value="JetBrains Mono">
        </label>
        <label style="width: 62%" class="suffix-pt">
          <input type="number" name="size" value="11" style="min-width: 8ch">
        </label>
      </fieldset>

      <label>
        <span lang="en">Template</span>
        <span lang="ru">Шаблон</span>
        <input type="file" name="template">
        <div class="choose-file">
        </div>
      </label>

      <fieldset>
        <legend>
          <span lang="en">Name placement</span>
          <span lang="ru">Расположение имени</span>
        </legend>
        <label class="suffix-percent">
          <input type="number" name="x" value="50">
        </label>
        <label class="suffix-percent">
          <input type="number" name="y" value="50">
        </label>
      </fieldset>

      <fieldset>
        <legend>
          <span lang="en">Alignment</span>
          <span lang="ru">Выравнивание</span>
        </legend>
        <label class="button radio-button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-text-align-start-icon lucide-text-align-start">
            <path d="M21 5H3"/>
            <path d="M15 12H3"/>
            <path d="M17 19H3"/>
          </svg>
          <input type="radio" name="alignment" value="left">
        </label>
        <label class="button radio-button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-text-align-center-icon lucide-text-align-center">
            <path d="M21 5H3"/>
            <path d="M17 12H7"/>
            <path d="M19 19H5"/>
          </svg>
          <input type="radio" name="alignment" value="center" checked>
        </label>
        <label class="button radio-button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-text-align-end-icon lucide-text-align-end">
            <path d="M21 5H3"/>
            <path d="M21 12H9"/>
            <path d="M21 19H7"/>
          </svg>
          <input type="radio" name="alignment" value="right">
        </label>
      </fieldset>

      <label>
        <span lang="en">Participants</span>
        <span lang="ru">Участники</span>
        <input type="file" name="participants">
        <div class="choose-file">
        </div>
      </label>
    </form>
  </div>

  <script>
    if (navigator.language.startsWith("ru")) {
      document.documentElement.lang = "ru"
    } else {
      document.title = "snlx.net / cert"
    }
  </script>

  <script type="module">
    import { pdfToImg } from "https://esm.run/pdftoimg-js/browser"
    import init, { TypJs } from "https://esm.run/typ-js"

    document.querySelectorAll("form").forEach((form) => {
      form.addEventListener('submit', (e) => {
        e.preventDefault()
        e.stopPropagation()
      });
    })

    let typ
    init().then(main)

    function main() {
      typ = TypJs.new()
      const noTemplateMessage = document.documentElement.lang === "ru" ? "Пожалуйста, выберите шаблон" : "Please upload a template"
      typ.write("main.typ", `#set page(paper: "a5", flipped: true, fill: rgb("#1e1e2e"))
#set align(center)
#set par(spacing: 8mm)
#text(size: 5cm, fill: rgb("#fab387"), emoji.warning)

#text(size: 8mm, fill: rgb("#cdd6f4"), font: "JetBrains Mono")[${noTemplateMessage}]`)

      const settingsElement = document.getElementById("settings")
      const namesTextarea = document.querySelector("textarea")
      const preview = document.getElementById("preview")
      const root = document.querySelector(":root")

      const printAll = document.getElementById("print-all")
      const saveEach = document.getElementById("save-each")

      let participants = [
        {
          name: document.documentElement.lang === "ru" ? "Иванов Иван" : "John Doe",
          email: "",
        },
        {
          name: document.documentElement.lang === "ru" ? "Петров Василий" : "Jane Smith",
          email: "",
        }
      ]
      
      const settings = {
        x: 50,
        y: 50,
        alignment: "left",
        font: "JetBrains Mono",
        size: "11pt",
      }

      preview.innerHTML = typ.svg()

      settingsElement.addEventListener("input", async (event) => {
        const data = new FormData(settingsElement)

        if (event.target.name === "template") {
          const template = data.get("template")
          settings.template = template.name
          const buf = await template.arrayBuffer()
          const array = new Uint8Array(buf)
          typ.attach(settings.template, array)
        }

        if (event.target.name === "participants") {
          let broken = ""

          const file = data.get("participants")
          if (!file) return
          const reader = new FileReader()
          reader.readAsText(file, "windows-1251")
          reader.addEventListener("load", () => {
            participants = reader.result
              .split("\n")
              .map(line => line.split(";").map(col => col.replace(/[\s"]/g, "")))
              .map(line => ({name: (line[5] || "") + " " + (line[6] || ""), email: line[9]}))
              .filter((line, idx) => {
                if (line.name === " ") {
                  const suffix = document.documentElement.lang === "ru" ? "не задал имя" : "does not have a name"
                  broken += `${idx} ${line.email} ${suffix}\n`
                  return false
                }
                if (line.email === "") {
                  const suffix = document.documentElement.lang === "ru" ? "не задал email" : "does not have an email"
                  broken += `${idx} ${line.name} ${suffix}\n`
                  return false
                }
                return true
              })

            alert(broken)
            console.log(participants)
          })
          return
        }

        settings.x = data.get("x") + "%"
        settings.y = data.get("y") + "%"
        settings.font = data.get("font")
        settings.size = data.get("size") + "pt"
        settings.alignment = data.get("alignment")

        buildPreview()
      })

      function buildPreview() {
        const pages = participants.map(person => buildPage(person, settings))
        preview.innerHTML = ""
        preview.append(...pages.map(({page, email}) => page))
      }
    }

    function buildPage({name, email}, settings) {
      const source = `#set page(
  fill: white,
  flipped: true,
  background: image("${settings.template}", height: 100%),
)

#let alignment = ${settings.alignment}
#let correction = if alignment == left { 0% } else if alignment == center { -50% } else { -100% }

#place(
  top + alignment,
  dx: ${settings.x} + correction,
  dy: ${settings.y},
  text(font: "${settings.font}",
  size: ${settings.size},
  [${name}],
  )
)`
      typ.write('main.typ', source)

      const e = typ.errors()
      if (e.length) {
        console.error(e)
      }

      const page = document.createElement("div")
      page.innerHTML = typ.svg()
      return {page, email}
    }
  </script>
</body>
</html>
