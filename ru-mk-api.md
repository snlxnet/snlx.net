---
tags:
  - project
  - archive
post: "[snlx.net](/snlx.net)"
created: 2026-01-01
updated: 2026-01-14T15:28:53+03:00
layout: base.njk
state: done
---

# Создание api.snlx.net
## Требования

После двух безуспешных попыток [сделать API этого сайта](/setting-up-api) и [подобрать под него систему](/ctr-os-4-api) у меня сложилось достаточное представление о том, что этот самый API должен делать и из чего он должен состоять.

Сейчас в процессе публикации заметок слишком много трения, поэтому и получается, что я и обновляю сайт раз в 500 лет. Цель этого проекта - избавиться от этого трения *самым простым способом*, т.е.
1. прийти к единой системе для всех заметок и документов, см. [ru-why-obsi](/ru-why-obsi)
2. доделать свои инструменты для этой системы

Самый простой набор своих инструментов, который я смог придумать
1. мост для obsidian для загрузки публичных заметок на github и закрытых на мой сервер, см. [mk-bridge](/mk-bridge)
2. сервер для хранения этих самых закрытых заметок, подробнее ниже

Основное требование к серверу - простота, поэтому он должен
- работать на alpine linux
- не давать доступ к оболочке
- не иметь движка контейнеров
- иметь приложение для управления им (то же, которое хранит закрытые заметки)
- не хранить важных данных, т.е. очищать диск при перезагрузке

Управляющее приложение должно
- в основном обрабатывать HTTP запросы
- заниматься простым auth (буду использовать перегенерируемый при перезагрузке UUID в качестве API ключа, что должно быть достаточно безопасно, т.к. zellij делает примерно так в своём web портале)
- управлять дочерними процессами (coturn, peerjs)
- хранить файлы
- немножко работать с вебсокетами

Эндпоинты
- `GET /status` переключается на WS соединение и кидает обновления статуса
- `POST /status?pass=...&action=...&link=...&location=...&duration=...` задаёт статус
- `POST /upgrade?pass=...` обновляет сервер
- `GET /file?id=...` загружает файл
- `POST /file?pass=...&id=...` сохраняет файл

Обновления статуса это карточка с "Currently..." на главной странице (ну когда я её доделаю).

Подробнее про сервер как бэкап: он им как бы является, но как бы нет. Он хранит копию obsidian vault'а, но удаляет её при перезагрузке и не должен отличаться от других устройств (перезагрузки гарантируют это).

Подробнее про `GET /file?id=...`: UI для этого это https://snlx.net/secret. Захóдите на страницу, вводите UUID закрытой заметки, страница идёт на сервер, запрашивает оттуда кучу HTML'а, он может содержать ссылки на другие закрытые файлы, которые тогда тоже доступны Вам. Это всё нужно для того, чтобы я мог делать заметки для работы и универа доступными им, но при этом не публичными.

## Создание проекта

Я хотел использовать gleam, но для сборки и запуска ему нужны:
- erlang
- gleam (логично)
- rebar3
- git

И сборка происходит в несколько команд. Я хотел простую систему, поэтому остановлюсь вместо этого на deno. Основное, что я теряю, это масштабируемость, но сейчас у меня 0 пользователей, так что это не проблема. Вместо того, чтобы оптимизировать под будущее, которое может не наступить, делаем простую штуку, которая будет работает сейчас.

`Deno.serve` достаточно приятно использовать для простых проектов вроде этого, я сделал auth очень быстро. На сервере не будет SSH, так что нужно придумать удобный способ вытащить из него ключ API. Один из вариантов это сделать - сгенерить для ключа QR код, вывести его в терминал и отсканировать оттуда. Для deno достаточно моного библиотек, которые могут это делать, я просто взял первую попавшуюся, которая нормально работала.

С загрузкой файлов было веселее, потому что я долго не мог понять, может ли
- `File` дать мне читаемый поток (он может, `file.stream()`)
- `Deno.writeFile` принять этот поток (может)

Потом, чтобы это протестировать, я сделал для него UI (на который потратил слишком много времени).

## Куда делось полдня?
Я изначально вообще не планировал делать UI, но... https://api.snlx.net делает отладку чуть удобнее.

## Вечер 2026-01-06 - обновление
Сам сервер готов, но я его ещё не деплоил. Попробую вернуться к этому 2026-01-10.

## Деплой сервера (2026-01-10)
Скрипт первоначальной настройки уже есть, остался [от прошлой попытки](https://snlx.net/setting-up-api/#:~:text=minimal%20setup). Последний раз проверяю это всё в виртуалке на моей системе, потом ставлю на реальный сервер.

Вообщем наткнулся на то, что github давал старую версию скрипта вместо последнего коммита, [это известная проблема](https://github.com/orgs/community/discussions/46691) и самым простым решением в моём случае было перемещение скрипта на статический сайт (этот). Ещё я добавил ему немного стилизации, [в ash можно делать многострочные комменты.](https://stackoverflow.com/questions/43158140/way-to-create-multiline-comments-in-bash) Интересный вариант получился, страница /api это файл, который интерпретируется по-разному разными средами, базовая структура:
```
: '
<h1>Html here</h1>
'

echo "and bash here"
```

Текстовое сообщение сгенерено `figlet api.snlx.net -f cybermedium`.

Теперь осталось только настроить caddy:
```caddyfile
api.snlx.net {
    reverse_proxy localhost:4242
}
```

## Оно работает
Честно говоря, я приятно удивлён caddy. Не, я, конечно, проверял, что оно будет работать на ВМ, но в прошлый раз я поставил NGINX и потом день разбирался, как заставить HTTPS работать, здесь же он просто заработал из коробки.

На данный момент (2026-01-10) система работает в бездисковом режиме, т.е. весь процесс установки выглядит очень близко к:

<link rel="stylesheet" type="text/css" href="/deps/asciinema-player.css">
<div id="cast" class="asciinema"></div>
<script src="/deps/asciinema-player.min.js"></script>
<script>
  AsciinemaPlayer.create('/api-setup.cast', document.getElementById('cast'), {
    terminalFontFamily: "JetBrains Mono",
    terminalFontSize: "0.67rem",
    rows: 24,
    cols: 97,
    fit: false,
  });
</script>

Sidenote: последне 2 часа я воевал с asciinema standalone плеером, потому что вначале мои базовые стили с ним не работали, а потом я пытался подогнать его по стилю под остальной сайт.

*Уточнение*: докер на видео используется для создания тестовой машины, в реальности это VPS и на ней нет движка контейнеров.

## Что дальше?
Этот проект *завершён*, теперь нужно добавить поддержку закрытых заметок и статуса в [mk-bridge](/mk-bridge), потом доделать фронт.

Подробнее о закрытых заметках в [mk-secret](/mk-secret).
