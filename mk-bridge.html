<!doctype html>
<html>

<head>
    <title>mk-bridge</title>
    <link rel="stylesheet" href="https://snlx.net/new.css">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
</head>

<body>
    <nav>
        <h2>Linked Notes</h2>
        <ul>
            <li class="back"><a href="/why-obsi">why-obsi</a></li>
            <li class="back"><a href="/svelte-garden">svelte-garden</a></li>
            <li class="back"><a href="/ru-why-obsi">ru-why-obsi</a></li>
            <li class="back"><a href="/ru-why-obsi">ru-why-obsi</a></li>
            <li class="back"><a href="/ru-mk-api">ru-mk-api</a></li>
            <li class="back"><a href="/ru-mk-api">ru-mk-api</a></li>
            <li class="back"><a href="/post">post</a></li>
            <li class="back"><a href="/mk-api">mk-api</a></li>
            <li class="back"><a href="/mk-api">mk-api</a></li>
            <li class="back"><a href="/index">index</a></li>
            <li class="back"><a href="/drop-eleventy">drop-eleventy</a></li>
            <li class="current"><a href="/mk-bridge">mk-bridge</a></li>
            <li class="forward"><a href="/post">post</a></li>
            <li class="forward"><a href="/uni">uni</a></li>
            <li class="forward"><a href="/mk-api">mk-api</a></li>
            <li class="forward"><a href="/mk-api">mk-api</a></li>
            <li class="forward"><a href="/mk-secret">mk-secret</a></li>
            <li class="forward"><a href="/svelte-garden">svelte-garden</a></li>
        </ul><a class="source" href="https://github.com/snlxnet/snlx.net"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-github-icon lucide-github">
                <path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path>
                <path d="M9 18c-4.51 2-5-2-7-2"></path>
            </svg>Source&nbsp;code</a>
    </nav>
    <main>
        <div class="metadata">
            <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-feather-icon lucide-feather">
                    <path d="M12.67 19a2 2 0 0 0 1.416-.588l6.154-6.172a6 6 0 0 0-8.49-8.49L5.586 9.914A2 2 0 0 0 5 11.328V18a1 1 0 0 0 1 1z"></path>
                    <path d="M16 8 2 22"></path>
                    <path d="M17.5 15H9"></path>
                </svg>created 32d ago</div>
            <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw-icon lucide-refresh-cw">
                    <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                    <path d="M21 3v5h-5"></path>
                    <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                    <path d="M8 16H3v5"></path>
                </svg>updated 0.36 hrs ago</div>
            <div class="tag">#project</div>
        </div>
        <pre class="frontmatter language-yaml" style="display: none;"><code class="language-yaml is-loaded"><span class="token key atrule">tags</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> project
<span class="token key atrule">created</span><span class="token punctuation">:</span> <span class="token datetime number">2026-01-05</span>
<span class="token key atrule">updated</span><span class="token punctuation">:</span> <span class="token datetime number">2026-02-06T22:40:36+03:00</span>
<span class="token key atrule">up</span><span class="token punctuation">:</span> <span class="token string">"[[snlx.net]]"</span>
<span class="token key atrule">post</span><span class="token punctuation">:</span> <span class="token string">"[[snlx.net]]"</span>
<span class="token key atrule">layout</span><span class="token punctuation">:</span> base.njk
<span class="token key atrule">state</span><span class="token punctuation">:</span> wip</code></pre>
        <p dir="auto">bridge is a plugin that ties Obsidian.md to my site</p>
        <h2 data-heading="Which notes" dir="auto">Which notes</h2>
        <p dir="auto">Public notes are easy, they are currently marked as <code>post: "[[snlx.net]]"</code> because I've been using <a data-href="post" href="/post" class="internal-link">post</a> to extract them.</p>
        <p dir="auto">My old way of dealing with private notes is marking them with <code>post: "[[uni]]"</code> and putting them into a separate directory with that same tool. </p>
        <p dir="auto">The new way: if a note has a UUID in its frontmatter, post it to the secure section.</p>
        <h2 data-heading="Link resolution" dir="auto">Link resolution</h2>
        <ul>
            <li dir="auto">go through each linked note and see if it has a UUID or a post tag</li>
            <li dir="auto">if it has a UUID, replace the link with <code>[name](/secure?id=uuid)</code></li>
            <li dir="auto">otherwise leave the link</li>
        </ul>
        <h2 data-heading="Publishing" dir="auto">Publishing</h2>
        <p dir="auto">The notes are sorted into secret and public</p>
        <ul>
            <li dir="auto">secret are sent to the API, see <a data-href="mk-api" href="/mk-api" class="internal-link">mk-api</a></li>
            <li dir="auto">public are sent to the github API</li>
        </ul>
        <h2 data-heading="How to even make a plugin" dir="auto">How to even make a plugin</h2>
        <p dir="auto">You clone the obsidian-sample plugin and then rely on the plugin developer docs and typescirpt intellisense to find the APIs you need.</p>
        <h2 data-heading="GitHub API?" dir="auto">GitHub API?</h2>
        <p dir="auto">I thought that would be easy. Silly me. The <a data-tooltip-position="top" aria-label="https://github.com/oleeskild/obsidian-digital-garden" class="external-link" href="https://github.com/oleeskild/obsidian-digital-garden">obsidian-digital-garden project</a> already does a similar thing and is licensed under MIT, so I've decided to check out how they are doing it. They are <a data-tooltip-position="top" aria-label="https://github.com/oleeskild/obsidian-digital-garden/blob/main/src/repositoryConnection/RepositoryConnection.ts#L282" class="external-link" href="https://github.com/oleeskild/obsidian-digital-garden/blob/main/src/repositoryConnection/RepositoryConnection.ts#L282">using</a> octokit to make a new commit from individual files.</p>
        <p dir="auto">I've copied to commit logic, tweaking it a bit to my format and I'm delighted to say that it works! That's it for today (2026-01-05), the main tasks for tomorrow are</p>
        <ul>
            <li dir="auto">making uploads lazy (currently it re-uploads all files even if they haven't changed and this is painful for images)</li>
            <li dir="auto">implementing (at least in part) the secret note publishing</li>
        </ul>
        <h2 data-heading="How do I even do lazy uploads?" dir="auto">How do I even do lazy uploads?</h2>
        <p dir="auto">To do lazy uploads I need to know when the file changed here and when it last changed on the server. For the sake of not making more requests than I strictly need, I'll store the last upload datetime of each file in the vault.</p>
        <p dir="auto">So I create a file called <code>bridge-sys</code> that uses frontmatter to store filenames as keys, their last update as of the last upload as values. Then the plugin can compare the actual last update to the last update as of last upload and re-upload if that has changed.</p>
        <h2 data-heading="Linked projects are fun!" dir="auto">Linked projects are fun!</h2>
        <p dir="auto">I've implemented (by 2026-01-06 1PM) the github uploads and now I want to do the rest, but to do the rest I first need to finish <a data-href="mk-api" href="/mk-api" class="internal-link">mk-api</a>, switching to that!</p>
        <h2 data-heading="Evening 2026-01-06 update" dir="auto">Evening 2026-01-06 update</h2>
        <p dir="auto">I'm now using this in my primary vault! The secret notes still don't work because the API is done but not deployed, though.</p>
        <p dir="auto">This very update was pushed using the plugin!</p>
        <h2 data-heading="2026-01-07 update" dir="auto">2026-01-07 update</h2>
        <p dir="auto">I'm using syncthing to keep the vault on my phone &amp; tablet up to date. Running the publish action on mobile results in a full re-upload of everything. That means I need it to rely on the frontmatter updated field instead of the file stats and switch that field to full ISO datetime.</p>
        <p dir="auto">I don't need <em>my</em> plugin to update that field as there's already <a data-tooltip-position="top" aria-label="obsidian://show-plugin?id=frontmatter-modified-date" class="external-link" href="obsidian://show-plugin?id=frontmatter-modified-date">a plugin for that</a>.</p>
        <h2 data-heading="That wasn't the issue" dir="auto">That wasn't the issue</h2>
        <p dir="auto">It's 2026-01-10 I've found out that I told it to update the file no matter if it was changed or not. Still, I like having the update field be more precise, so I'll keep the change with that plugin.</p>
        <p dir="auto">(testing the changes, this line was added on my phone)</p>
        <p dir="auto">And it didn't work. The phone tried to update all images, which takes a while. And that means</p>
        <h2 data-heading="It *was* part of the problem" dir="auto">It <em>was</em> part of the problem</h2>
        <p dir="auto">I don't think there's any real way to add metadata to random files (aside from HTML comments, that would break if I ever added a raster image), so the best option seems to be to compare the updated dates with some margin for sync. Everything usually syncs within a minute at most, so I'll make the wait window 15 minutes just to be sure.</p>
        <p dir="auto">(writing this on my phone to test it) sidenote: I'm not currently using a pomodoro because my timer was running in Obsidian and i need to reload Obsidian to test the plugin. So the timer got stopped and the new one (just a timer on my phone) doesn't switch to break automatically and I keep snoozing it. Dumbest problem ever.</p>
        <p dir="auto">Oh wow <a data-tooltip-position="top" aria-label="https://github.com/snlxnet/snlx.net/commit/e167d55804da7bf2300e8900026a049ea698fb56" class="external-link" href="https://github.com/snlxnet/snlx.net/commit/e167d55804da7bf2300e8900026a049ea698fb56">I may have a problem here</a>. The plugin on mobile updated all files. Even though I told it not to. Well, I've added datetime update dates (I don't know how to say that) on all files to see if pushing tomorrow will touch those dates. It shouldn't.</p>
        <h2 data-heading="And now with the API done" dir="auto">And now with the API done</h2>
        <p dir="auto">2026-01-11 It's time to implement secret note uploading in the plugin. I mean, it <em>should</em> be a simple POST request. What could go wrong?</p>
        <p dir="auto">Oh of course I would run into CORS. I've added a snippet from <a data-tooltip-position="top" aria-label="https://caddyserver.com/docs/caddyfile/directives/import" class="external-link" href="https://caddyserver.com/docs/caddyfile/directives/import">caddy docs</a> to my config, now Obsidian gets a 200 OK with status CORS error.</p>
        <p dir="auto">The access control header is not found in the response. That's weird. Rebooting the entire server just to be sure.</p>
        <p dir="auto">Same issue. Ah yes of course I did:</p>
        <pre><code>api.snlx.net {
	import cors example.com
	reverse_proxy localhost:4242
}
</code></pre>
        <p dir="auto">With the allow origin header set everything is done and is working! I'm moving the updated plugin build to my primary vault.</p>
        <h2 data-heading="Secret notes" dir="auto">Secret notes</h2>
        <p dir="auto">Continued in <a data-href="mk-secret" href="/mk-secret" class="internal-link">mk-secret</a>.</p>
        <h2 data-heading="Backlinks &amp; Redesign" dir="auto">Backlinks &amp; Redesign</h2>
        <p dir="auto">I've had a pretty good idea of how the site should look like, like, 2 years ago? Then I forgot about it. A few weeks ago, I've found a sketch in the archives and wanted to finally bring it to life.</p>
        <p dir="auto">Aside: I've wanted to try <a data-href="svelte-garden" href="/svelte-garden" class="internal-link">svelte-garden</a>, but decided not to, more in that note.</p>
        <p dir="auto">The plugin <a data-tooltip-position="top" aria-label="https://github.com/snlxnet/bridge/tree/9ae9ea9bdac8f81a4253ca5b8cab1593a52c3265" class="external-link" href="https://github.com/snlxnet/bridge/tree/9ae9ea9bdac8f81a4253ca5b8cab1593a52c3265">now</a> outputs HTML directly, rendered by Obsidian. This means that callouts are now easier to implement and typst math blocks finally work. I'll get back to this within the week (maybe even today) <del>&amp; make it output both HTML &amp; MD so that the source files are downloadable, too.</del> And I need to add redirects. And show the metadata.</p>
        <p dir="auto">I may also put private links into the public garden, I don't know yet. They will obviously still not work, but they may be useful for those who do have access.</p>
        <p dir="auto">2026-02-05 This was the stupidest thing I've ever written and the stupidest thing I've ever fixed:</p>
        <pre class="language-diff"><code class="language-diff is-loaded">diff --git i/src/main.ts w/src/main.ts
index d2b4a20..aa94d0c 100644
<span class="token coord">--- i/src/main.ts</span>
<span class="token coord">+++ w/src/main.ts</span>
@@ -239,7 +239,7 @@ export default class Bridge extends Plugin {

return {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   name: note.file.name,
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">   updated: note.file,
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   updated: note.updated,
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   body: note.body.replace(REGEXES.wiki, "[$1](/$1)"),
</span><span class="token prefix unchanged"> </span><span class="token line">   html,
</span><span class="token prefix unchanged"> </span><span class="token line">   redirect: note.redirect,
</span></span></code></pre>
        <p dir="auto">It was causing the call stack to overflow.</p>
        <hr>
        <p dir="auto">It's almost ready, I just have to make the gh action &amp; add note metadata to the html output. Deploying to this site 2026-02-06!</p>
        <hr>
        <p dir="auto">To speed up the deployment, I will still go through eleventy. It will be doing nothing but moving around HTML files now, so I'll get rid of it in the action soon-ish.</p>
        <p dir="auto">Step one is deleting all the existing markdown files from the repo as they are not going to be updated for now. This is fun as I have to cancel the build early or it will delete the entire site. Step two is running the new plugin.</p>
    </main>
    <script src="https://snlx.net/mobile.js"></script>
    <!-- TODO router.js -->
    <!-- TODO include typ.js everywhere so it's downloaded in the bg & cached -->
</body>

</html>