<!doctype html>
<html>

<head>
    <title>mk-api</title>
    <link rel="stylesheet" href="https://snlx.net/new.css">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
</head>

<body>
    <nav>
        <h2>Linked Notes</h2>
        <ul>
            <li class="back"><a href="/rebuilding">rebuilding</a></li>
            <li class="back"><a href="/mk-bridge">mk-bridge</a></li>
            <li class="back"><a href="/index">index</a></li>
            <li class="back"><a href="/cert-typ">cert-typ</a></li>
            <li class="current"><a href="/mk-api">mk-api</a></li>
            <li class="forward"><a href="/rebuilding">rebuilding</a></li>
            <li class="forward"><a href="/mk-bridge">mk-bridge</a></li>
            <li class="forward"><a href="/index">index</a></li>
            <li class="forward"><a href="/cert-typ">cert-typ</a></li>
        </ul><a class="source" href="https://github.com/snlxnet/snlx.net"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-github-icon lucide-github">
                <path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path>
                <path d="M9 18c-4.51 2-5-2-7-2"></path>
            </svg>Source&nbsp;code</a>
    </nav>
    <main>
        <div class="metadata">
            <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-feather-icon lucide-feather">
                    <path d="M12.67 19a2 2 0 0 0 1.416-.588l6.154-6.172a6 6 0 0 0-8.49-8.49L5.586 9.914A2 2 0 0 0 5 11.328V18a1 1 0 0 0 1 1z"></path>
                    <path d="M16 8 2 22"></path>
                    <path d="M17.5 15H9"></path>
                </svg>created 36d ago</div>
            <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw-icon lucide-refresh-cw">
                    <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                    <path d="M21 3v5h-5"></path>
                    <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                    <path d="M8 16H3v5"></path>
                </svg>updated 13d ago</div>
            <div class="tag">#project</div>
            <div class="tag">#archive</div>
        </div>
        <pre class="frontmatter language-yaml" style="display: none;"><code class="language-yaml is-loaded"><span class="token key atrule">tags</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> project
  <span class="token punctuation">-</span> archive
<span class="token key atrule">post</span><span class="token punctuation">:</span> <span class="token string">"[[snlx.net]]"</span>
<span class="token key atrule">created</span><span class="token punctuation">:</span> <span class="token datetime number">2026-01-01</span>
<span class="token key atrule">updated</span><span class="token punctuation">:</span> <span class="token datetime number">2026-01-24T11:58:49+03:00</span>
<span class="token key atrule">layout</span><span class="token punctuation">:</span> base.njk
<span class="token key atrule">state</span><span class="token punctuation">:</span> done</code></pre>
        <h1 data-heading="Making api.snlx.net" dir="auto">Making api.snlx.net</h1>
        <h2 data-heading="Requirements" dir="auto">Requirements</h2>
        <p dir="auto">After failing twice at <a data-href="setting-up-api" href="/setting-up-api" class="internal-link">setting-up-api</a> and not finding a good <a data-href="ctr-os-4-api" href="/ctr-os-4-api" class="internal-link">ctr-os-4-api</a>, I've come up with a good (I think) idea of what I want the API to look like and what I want it to do.</p>
        <p dir="auto">My publishing workflow has a ton of friction, that's why I update the site like once in a decade. I want to get rid of that in the <em>simplest way possible</em>. That means</p>
        <ol>
            <li dir="auto">centralizing on one note-taking system, see <a data-href="why-obsi" href="/why-obsi" class="internal-link">why-obsi</a></li>
            <li dir="auto">making custom tools for that system</li>
        </ol>
        <p dir="auto">The simplest set of custom tools I could come up with is</p>
        <ol>
            <li dir="auto">a bridge for obsidian that pushes private notes to the server and public notes to github, see <a data-href="mk-bridge" href="/mk-bridge" class="internal-link">mk-bridge</a></li>
            <li dir="auto">a server that stores private notes, see the rest of this note</li>
        </ol>
        <p dir="auto">My primary requirement for the server is simplicity, so it</p>
        <ul>
            <li dir="auto">runs alpine linux</li>
            <li dir="auto">doesn't give me shell access</li>
            <li dir="auto">doesn't have a container engine</li>
            <li dir="auto">runs a single management app (the same app that serves secret notes)</li>
            <li dir="auto">is stateless, wipes the permanent files at reboot</li>
        </ul>
        <p dir="auto">The management app needs to</p>
        <ul>
            <li dir="auto">mostly work with HTTP requests</li>
            <li dir="auto">do basic auth (I'll use a UUID for an API key and regenerate it at every reboot, I mean it should be fine because zellij is doing that for their web portal)</li>
            <li dir="auto">manage child processes (coturn, peerjs)</li>
            <li dir="auto">store files</li>
            <li dir="auto">work with WS a little</li>
        </ul>
        <p dir="auto">The endpoints</p>
        <ul>
            <li dir="auto"><code>GET /status</code> switches to a WS with the status updates</li>
            <li dir="auto"><code>POST /status?pass=...&amp;action=...&amp;link=...&amp;location=...&amp;duration=...</code> updates the status</li>
            <li dir="auto"><code>POST /upgrade?pass=...</code> upgrades the server</li>
            <li dir="auto"><code>GET /file?id=...</code> loads a file</li>
            <li dir="auto"><code>POST /file?pass=...&amp;id=...</code> saves a file</li>
        </ul>
        <p dir="auto">Status updates are the "Currently..." thing on my homepage (when I implement that).</p>
        <p dir="auto">More on the server being a backup: it kind of is. It has a copy of my vault (<a data-href="why-obsi" href="/why-obsi" class="internal-link">why-obsi</a>, that vault), but deletes it at reboot and must not differ from any other device (the reboots make sure of that).</p>
        <p dir="auto">More on <code>GET /file?id=...</code>, the UI for it is <a class="external-link" href="https://snlx.net/secret">https://snlx.net/secret</a>. You go on that page, enter the UUID of a secret file, it goes to the server, requests a bunch of HTML, that HTML can contain links to other secret files which you can then visit. This is so I can have work / uni files that are accessible by a link, but not public.</p>
        <h2 data-heading="Init" dir="auto">Init</h2>
        <p dir="auto">I was going to try gleam, but look at what it needs to build and run:</p>
        <ul>
            <li dir="auto">erlang</li>
            <li dir="auto">gleam (obviously)</li>
            <li dir="auto">rebar3</li>
            <li dir="auto">git</li>
        </ul>
        <p dir="auto">And the build is multiple commands. I want simplicity, so I'll use deno instead. The primary thing I'm loosing is scalability, but I currently have zero users anyway so it's not a problem. I don't want to optimize for a potential future that may never come, I want to build a simple thing now.</p>
        <p dir="auto"><code>Deno.serve</code> is quite nice for simple apps like this, auth was done in no time. I'll be running this on a server without SSH, so I need a way to get the API key out of it. One reasonable way to do that is to generate a qr code, print it in the terminal, and scan it. There are a lot of libraries for deno that do that, I've just settled on the first one I found that looked okay.</p>
        <p dir="auto">File uploads were fun because I couldn't figure out if</p>
        <ul>
            <li dir="auto">the <code>File</code> object can give me a readable stream (it can, <code>file.stream()</code>)</li>
            <li dir="auto"><code>Deno.writeFile</code> would accept that stream (it would)</li>
        </ul>
        <p dir="auto">Then I wanted to test it, so I made a UI. Spent too much time on that tbh.</p>
        <h2 data-heading="Where did half the day go?" dir="auto">Where did half the day go?</h2>
        <p dir="auto">I didn't plan to make a UI. But... <a class="external-link" href="https://api.snlx.net">https://api.snlx.net</a> it will make debugging a bit nicer.</p>
        <h2 data-heading="Evening 2026-01-06 update" dir="auto">Evening 2026-01-06 update</h2>
        <p dir="auto">I think the actual server is done, though I haven't deployed it yet. I'll try to get back to this 2026-01-10.</p>
        <h2 data-heading="Deploying the server (2026-01-10)" dir="auto">Deploying the server (2026-01-10)</h2>
        <p dir="auto">The bootstrap already exists, see <a data-tooltip-position="top" aria-label="https://snlx.net/setting-up-api/#:~:text=minimal%20setup" class="external-link" href="https://snlx.net/setting-up-api/#:~:text=minimal%20setup">setting up api</a> for that. I'll test that in a local VM one last time and then move on to the real thing.</p>
        <p dir="auto">I ended up running into a problem with github serving an older version of the bootstrap script, <a data-tooltip-position="top" aria-label="https://github.com/orgs/community/discussions/46691" class="external-link" href="https://github.com/orgs/community/discussions/46691">this is a known thing</a> and the simplest solution for me is to move the script into the main site repo. I've also made it look a bit better by adding comments <a data-tooltip-position="top" aria-label="https://stackoverflow.com/questions/43158140/way-to-create-multiline-comments-in-bash" class="external-link" href="https://stackoverflow.com/questions/43158140/way-to-create-multiline-comments-in-bash">did you know ash has multiline comments?</a> This is a trick I like to use now, you can make a file that is interpreted in different ways by different environments:</p>
        <pre><code>: '
&lt;h1&gt;Html here&lt;/h1&gt;
'

echo "and bash here"
</code></pre>
        <p dir="auto">The message is generated using <code>figlet api.snlx.net -f cybermedium</code>.</p>
        <p dir="auto">Now all that's left is to set up caddy:</p>
        <pre class="language-caddyfile"><code class="language-caddyfile is-loaded">api.snlx.net {
    reverse_proxy localhost:4242
}
</code></pre>
        <h2 data-heading="It's done" dir="auto">It's done</h2>
        <p dir="auto">Honestly, I'm pleasantly surprised by caddy. I've tested the server on a VM and it worked there, but after having issues with NGINX the last time I tried to set up the server, deploying this onto the real machine and seeing it work the first time was very nice.</p>
        <p dir="auto">The system is currently (2026-01-10) running in diskless mode, so the entire setup process looked like this:</p>

        <div class="asciinema" id="cast"></div>


        <p dir="auto">Sidenote: I've been battling the asciinema standalone player for the past 2 hours because my base styles refused to work with it and then because I wanted to make it fit in.</p>
        <p dir="auto"><em>Clarification</em>: I'm using docker in the video to create a test machine, the actual server is a VPS with no container engine.</p>
        <h2 data-heading="What's next?" dir="auto">What's next?</h2>
        <p dir="auto">This project is <em>done</em>, now I need to update <a data-href="mk-bridge" href="/mk-bridge" class="internal-link">mk-bridge</a> to support secret notes and status updates, then make the frontend able to read both.</p>
        <p dir="auto">More on the secret notes in <a data-href="mk-secret" href="/mk-secret" class="internal-link">mk-secret</a>.</p>
    </main>
    <script src="https://snlx.net/mobile.js"></script>
    <!-- TODO router.js -->
    <!-- TODO include typ.js everywhere so it's downloaded in the bg & cached -->
</body>

</html>